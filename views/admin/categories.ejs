<!doctype html>
<html lang="vi">

<head>
  <title>Quản lý danh mục sản phẩm</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <!-- VENDOR CSS -->
  <link rel="stylesheet" href="/admin/vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/admin/vendor/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/admin/vendor/linearicons/style.css">
  <link rel="stylesheet" href="/admin/vendor/bootstrap-select/bootstrap-select.min.css">
  <link rel="stylesheet" href="/admin/css/animate.min.css">
  <!-- MAIN CSS -->
  <link rel="stylesheet" href="/admin/css/main.css">
  <!-- GOOGLE FONTS -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet">
  <!-- ICONS -->
  <link rel="apple-touch-icon" sizes="76x76" href="/admin/img/apple-icon.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/admin/img/favicon.png">
</head>

<body>
<!-- WRAPPER -->
<div id="wrapper">
  <!-- NAVBAR -->
  <%- include('component/_navbar') %>
  <!-- END NAVBAR -->
  <!-- LEFT SIDEBAR -->
  <%- include('component/_sidebar') %>
  <!-- END LEFT SIDEBAR -->
  <!-- MAIN -->
  <div class="main">
    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="container-fluid">
        <h3 class="page-title">Quản lý danh mục</h3>
        <% if (typeof flashStatus !== "undefined" && typeof flashMessage !== "undefined") { %>
        <div class="alert alert-<%= flashStatus %> alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
          <i class="fa fa-check-circle"></i> <%= flashMessage %>
        </div>
        <% } %>
        <% parentCategory = categories.filter(cat => cat['parent_id'] == 0) %>
        <% subCategory = categories.filter(cat => cat['parent_id'] != 0) %>
        <div class="row">
          <div class="col-md-12">
            <!-- PANEL PARENT CATEGORY -->
            <div class="panel">
              <div class="panel-heading">
                <h3 class="panel-title">Danh mục lớn (cấp 1)</h3>
                <p class="panel-subtitle">Sửa trực tiếp trên tên danh mục và lưu lại</p>
                <div class="right">
                  <button type="button" class="btn-toggle-collapse"><i class="lnr lnr-chevron-up"></i></button>
                  <button type="button" class="btn-remove"><i class="lnr lnr-cross"></i></button>
                </div>
              </div>
              <div class="panel-body">
                <table class="table table-hover">
                  <thead>
                  <tr>
                    <th>
                      <div class="row">
                        <div class="col-8 col-md-8">Tên danh mục</div>
                        <div class="col-2 col-md-2">Ngày tạo</div>
                        <div class="col-2 col-md-2">Hành động</div>
                      </div>
                    </th>

                  </tr>
                  </thead>
                  <tbody>
                  <% parentCategory.forEach(cat => { %>
                  <tr id="tr_<%= cat['id'] %>">
                    <td>
                      <div class="row">
                        <div class="col-8 col-md-8">
                          <input id="category_<%= cat['id'] %>" class="form-control" value="<%= cat['name'] %>" placeholder="Tên danh mục">
                        </div>
                        <div class="col-2 col-md-2">
                          <%= formatDay(cat['created_at'], true) %>
                        </div>
                        <div class="col-2 col-md-2">
                          <button class="btn btn-sm" data-toggle="tooltip" title="Cập nhật" onclick="updateCategory(<%= cat['id'] %>)">
                            <span class="fa fa-wrench"></span>
                          </button>
                          <button class="btn btn-sm btn-danger btn-delete" data-toggle="tooltip" title="Xóa" type="button" onclick="deleteCategory(<%= cat['id'] %>)">
                            <span class="fa fa-trash"></span>
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                  </tbody>
                </table>
                <div class="row">
                  <div class="col-md-12">
                    <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#createParentCategory" aria-expanded="false" aria-controls="collapseExample">
                      Thêm danh mục mới
                    </button>
                    <div class="collapse mt-4" id="createParentCategory">
                      <form method="post" action="/admin/categories">
                        <div class="panel panel-body">
                          <div class="row">
                            <div class="col-8 col-md-8">
                              <label>Tên danh mục</label>
                              <input type="hidden" name="parent_id" value="0">
                              <input name="category_id" class="form-control" placeholder="Tên danh mục">
                            </div>
                          <div class="col-3 col-md-3">
                            <label class="w-100">&nbsp;&nbsp;</label>
                            <button class="btn btn-success" data-toggle="tooltip" title="Thêm">
                              <i class="fa fa-plus"> </i> Thêm
                            </button>
                          </div>
                        </div>
                      </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel-footer">
                <h5>Các danh mục này sẽ chứa các danh mục nhỏ (cấp 2)</h5>
              </div>
            </div>
            <!-- END PARENT CATEGORY -->
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <!-- PANEL SUB CATEGORY -->
            <div class="panel">
              <div class="panel-heading">
                <h3 class="panel-title">Danh mục nhỏ (cấp 2)</h3>
                <p class="panel-subtitle">Sửa tên trực tiếp, cũng như danh mục cha và lưu lại</p>
                <div class="right">
                  <button type="button" class="btn-toggle-collapse"><i class="lnr lnr-chevron-up"></i></button>
                  <button type="button" class="btn-remove"><i class="lnr lnr-cross"></i></button>
                </div>
              </div>
              <div class="panel-body">
                <table class="table table-hover">
                  <thead>
                  <tr>
                    <th>
                      <div class="row">
                        <div class="col-8 col-sm-4">Tên danh mục</div>
                        <div class="col-8 col-sm-4">Danh mục cha</div>
                        <div class="col-2 col-sm-2">Ngày tạo</div>
                        <div class="col-2 col-sm-2">Hành động</div>
                      </div>
                    </th>

                  </tr>
                  </thead>
                  <tbody>
                  <% subCategory.forEach(cat => { %>
                  <tr id="tr_<%= cat['id'] %>">
                    <td>
                      <div class="row">
                        <div class="col-8 col-sm-4">
                          <input id="category_<%= cat['id'] %>" class="form-control" value="<%= cat['name'] %>" placeholder="Tên danh mục">
                        </div>
                        <div class="col-8 col-sm-4">
                          <select id="parent_id_<%= cat['id'] %>" class="selectpicker form-control " name="parent_id" data-live-search="true" data-live-search-style="begins" title="Vui lòng chọn...">
                            <% parentCategory.forEach(parentCat => { %>
                            <option value="<%= parentCat['id'] %>" <%= cat['parent_id'] == parentCat['id']? 'selected': '' %>><%= parentCat['name'] %></option>
                            <% }) %>
                          </select>
                        </div>
                        <div class="col-2 col-sm-2">
                          <%= formatDay(cat['created_at'], true) %>
                        </div>
                        <div class="col-2 col-sm-2">
                          <button class="btn btn-sm" data-toggle="tooltip" title="Cập nhật" onclick="updateCategory(<%= cat['id'] + ', false' %>)">
                            <span class="fa fa-wrench"></span>
                          </button>
                          <button class="btn btn-sm btn-danger btn-delete" data-toggle="tooltip" title="Xóa" type="button" onclick="deleteCategory(<%= cat['id'] %>)">
                            <span class="fa fa-trash"></span>
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                  </tbody>
                </table>
                <div class="row">
                  <div class="col-md-12">
                    <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#createSubCategory" aria-expanded="false" aria-controls="collapseExample">
                      Thêm danh mục mới
                    </button>
                    <div class="collapse mt-4" id="createSubCategory">
                      <form method="post" action="/admin/categories">
                        <div class="panel panel-body">
                          <div class="row">
                            <div class="col-8 col-md-4">
                              <label>Tên danh mục</label>
                              <input name="category_id" class="form-control" placeholder="Tên danh mục">
                            </div>
                            <div class="col-8 col-md-4">
                              <label>Danh mục cha</label>
                              <select class="selectpicker form-control " name="parent_id" data-live-search="true" data-live-search-style="begins" title="Vui lòng chọn...">
                                <% parentCategory.forEach(parentCat => { %>
                                <option value="<%= parentCat['id'] %>"><%= parentCat['name'] %></option>
                                <% }) %>
                              </select>
                            </div>
                            <div class="col-3 col-md-3">
                              <label class="w-100">&nbsp;&nbsp;</label>
                              <button class="btn btn-success" data-toggle="tooltip" title="Thêm" type="submit">
                                <i class="fa fa-plus"> </i> Thêm
                              </button>
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel-footer">
                <h5>Các danh mục con sẽ nằm trong danh mục cha</h5>
              </div>
            </div>
            <!-- END SUB CATEGORY -->
          </div>
        </div>
      </div>
    </div>
    <!-- END MAIN CONTENT -->
  </div>
  <!-- END MAIN -->
  <div class="clearfix"></div>
  <footer>
    <div class="container-fluid">
    </div>
  </footer>
</div>
<!-- END WRAPPER -->
<!-- Javascript -->
<script src="/admin/vendor/jquery/jquery.min.js"></script>
<script src="/admin/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/admin/vendor/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="/admin/vendor/bootstrap-select/bootstrap-select.min.js"></script>

<script src="/admin/js/bootstrap-notify.js"></script>
<script src="/admin/js/admin-common.js"></script>

<script>
  updateCategory = (id, isParent = true) => {
    let newCategoryName = $(`#category_${id}`).val();
    let parentId = isParent ? 0 : $(`#parent_id_${id}`).val();
    $.ajax({
      url: "/admin/categories",
      method: 'PUT',
      data: {
        category_id: id,
        name: newCategoryName,
        parent_id: parentId
      },
      success: function(result) {
        console.log(result);
        if (result && result.status === 'success') {
          showAlert('success', result.message ? result.message : message.update_success);
        } else {
          showAlert('success', result.message ? result.message : message.update_failed);
        }
      },
      failed: function(error) {
        showAlert('danger', error);
      }
    });
  }
  function deleteCategory(id) {
    if (confirm(message.confirm_delete)) {
      $.ajax({
        url: "/admin/categories",
        method: 'delete',
        data: {
          category_id: id
        },
        success: function(result) {
          console.log(result);
          if (result && result.status === 'success') {
            showAlert('success', message.delete_success);
            $(`#tr_${id}`).hide(500);
          } else {
            showAlert('danger', message.delete_failed);
          }
        },
        failed: function(error) {
          showAlert('danger', error);
        }
      });
    }
  }
</script>
</body>

</html>